
'use client';

import { useState, useMemo } from 'react';
import { useRouter } from 'next/navigation';
import { useAuth } from '@/context/AuthContext';
import { Button } from "@/components/ui/button";
import { Card, CardContent } from '@/components/ui/card';
import { Checkbox } from "@/components/ui/checkbox";
import { Label } from "@/components/ui/label";
import { ArrowLeft, GripVertical, CheckIcon, Zap } from "lucide-react";
import { cn } from '@/lib/utils';
import dynamic from 'next/dynamic';
import Image from 'next/image';

const DynamicDotLottie = dynamic(
  () => import('@lottiefiles/dotlottie-react').then((mod) => mod.DotLottieReact),
  { ssr: false }
);

// --- Pet Avatar Component ---
const GamePet = ({ isInteracting }: { isInteracting: boolean }) => {
    return (
        <div className={cn("relative transition-transform drop-shadow-lg", isInteracting && "animate-jump")}>
            <DynamicDotLottie
                src="https://lottie.host/09487b01-8ddf-44ee-9132-312a993d0950/OwLvmZQ781.lottie"
                loop
                autoplay
                speed={0.5}
                className="w-36 h-36"
            />
        </div>
    );
};

// --- Background Component ---
const GameBackground = () => {
  return (
    <div className="absolute inset-0 z-0 overflow-hidden bg-white">
      <svg width="100%" height="100%" viewBox="0 0 393 852" fill="none" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMax slice" className="absolute bottom-0 left-0 w-full h-auto">
          <g clipPath="url(#clip0_9_73_game)">
              <path d="M0 0H393V262H0V0Z" fill="url(#paint0_linear_9_73_game)"></path>
              <rect y="295" width="393" height="1427" fill="#71EA71"></rect>
              <path d="M51.6667 33.3333C51.6667 33.3333 51.6667 30 55 30C58.3333 30 58.3333 33.3333 58.3333 33.3333V36.6667C58.3333 36.6667 58.3333 40 55 40C51.6667 40 51.6667 36.6667 51.6667 36.6667V33.3333ZM81.6667 56.6667C81.6667 56.6667 85 56.6667 85 60C85 63.3333 81.6667 63.3333 81.6667 63.3333H78.3333C78.3333 63.3333 75 63.3333 75 60C75 56.6667 78.3333 56.6667 78.3333 56.6667H81.6667ZM31.6667 56.6667C31.6667 56.6667 35 56.6667 35 60C35 63.3333 31.6667 63.3333 31.6667 63.3333H28.3333C28.3333 63.3333 25 63.3333 25 60C25 56.6667 28.3333 56.6667 28.3333 56.6667H31.6667ZM40.2017 42.155C40.2017 42.155 42.5583 44.5117 40.2017 46.8683C37.845 49.225 35.4883 46.8683 35.4883 46.8683L33.13 44.5133C33.13 44.5133 30.7733 42.1567 33.13 39.7983C35.4883 37.4417 37.845 39.7983 37.845 39.7983L40.2017 42.155ZM74.5133 46.8683C74.5133 46.8683 72.1567 49.225 69.8 46.8683C67.4433 44.5117 69.8 42.155 69.8 42.155L72.1567 39.7983C72.1567 39.7983 74.5133 37.4417 76.87 39.7983C79.2267 42.155 76.87 44.5117 76.87 44.5117L74.5133 46.8683ZM39.5133 81.8683C39.5133 81.8683 37.1567 84.225 34.8 81.8683C32.4433 79.5117 34.8 77.155 34.8 77.155L37.1567 74.7983C37.1567 74.7983 39.5133 72.4417 41.87 74.7983C44.2267 77.155 41.87 79.5117 41.87 79.5117L39.5133 81.8683Z" fill="#FFAC33"></path>
              <path d="M55 76.6667C64.2048 76.6667 71.6667 69.2047 71.6667 60C71.6667 50.7953 64.2048 43.3333 55 43.3333C45.7953 43.3333 38.3334 50.7953 38.3334 60C38.3334 69.2047 45.7953 76.6667 55 76.6667Z" fill="#FFAC33"></path>
              <path d="M74.295 65.3333C73.225 65.3333 72.195 65.5 71.2233 65.8083C70.0767 62.4283 66.9567 60 63.2783 60C59.3317 60 56.0283 62.7967 55.1133 66.5617C54.1164 65.7722 52.8833 65.3403 51.6117 65.335C48.39 65.335 45.7783 68.02 45.7783 71.335C45.7783 72.14 45.9383 72.9033 46.2183 73.6067C45.6554 73.4334 45.0706 73.3414 44.4817 73.3333C40.9017 73.3333 38 76.3183 38 80C38 83.6817 40.9017 86.6667 44.4817 86.6667H74.2967C80.0233 86.6667 84.6667 81.8933 84.6667 76C84.6667 70.1083 80.0233 65.3333 74.295 65.3333Z" fill="#E1E8ED"></path>
              <path d="M393 344.867C392.345 345.154 391.631 345.396 390.853 345.567C387.669 346.269 384.847 345.968 382.945 345.651C380.303 345.211 380.43 344.942 376.781 344.649C373.288 344.369 367.084 344.234 355.5 344.832C348.764 345.18 346.868 345.466 345.878 345.663C342.295 346.378 328.942 349.347 316.336 353.407C309.565 355.588 303.615 357.645 298.858 359.405C293.645 361.334 286.42 364.436 278.825 366.062C270.718 367.797 259.438 368.917 247.118 368.755C239.112 368.649 230.49 368.986 223.523 367.503C214.88 365.663 210.704 363.89 202.37 359.946C196.889 357.353 193.736 355.782 187.938 353.904C186.528 353.448 185.008 352.836 184.015 352.458C182.886 352.029 181.761 351.629 180.402 351.257C177.72 350.522 173.651 349.768 166.771 349.558C149.84 349.04 139.134 349.178 137.555 349.215C136.529 349.239 135.548 349.301 134.255 349.378C133 349.453 131.54 349.535 129.842 349.565C119.668 349.748 107.929 349.661 96.7432 351.285C92.3442 351.924 88.5821 352.617 84.4922 353.271C80.6349 353.889 76.6505 354.441 72.8721 354.524C57.7013 354.861 52.4115 355.113 46.8271 354.315C42.9158 353.757 37.7387 353.422 32.5146 351.977C28.709 350.924 22.2981 350.237 15.1279 345.944C9.85442 342.787 4.93693 339.301 0 334.338V295H393V344.867ZM5.36523 314.162C5.35297 314.135 5.34127 314.108 5.3291 314.081C5.28317 314.055 5.23724 314.029 5.19141 314.002C5.24881 314.055 5.30714 314.108 5.36523 314.162Z" fill="#00CA00"></path>
              <path d="M251.663 173.339C255.277 172.586 258.668 173.213 261.169 173.999C263.837 174.838 266.245 176.094 268.142 177.306C270.723 178.954 272.663 180.945 274.08 182.567C274.79 183.38 275.437 184.181 275.956 184.825C276.515 185.518 276.908 186.007 277.281 186.437C280.268 189.874 282.719 193.45 287.093 199.69C292.337 207.173 295.193 211.505 297.305 214.131C299.635 217.029 302.936 218.035 308.381 220.163C308.649 220.268 309.655 220.513 311.713 220.607C313.621 220.695 315.782 220.631 318.033 220.524C327.989 220.052 333.16 218.226 335.142 217.452C337.727 216.443 340.251 215.574 347.499 213.145C351.578 211.777 354.965 210.89 359.186 210.705C361.797 210.59 364.863 210.381 371.521 210.567C376.731 210.713 380.994 213.042 382.766 213.825C385.49 215.029 388.953 216.688 392.139 220.396C392.457 220.767 392.742 221.147 393 221.531V297H0V235.743C2.01237 234.072 4.42949 232.079 7.33105 229.717C14.5423 223.845 22.2687 222.077 25.8857 221.215H25.8867L25.9551 221.198C30.4936 220.117 35.718 220.004 39.7422 220.16C43.5609 220.309 47.7191 220.76 50.0498 221.475C54.5441 222.852 58.4148 225.251 60.5498 226.688C62.538 228.027 65.6455 229.949 69.3643 231.6C69.4975 231.622 69.7278 231.657 70.0752 231.69C70.9822 231.778 72.254 231.826 73.8428 231.802C77.0104 231.754 80.9402 231.432 84.8184 230.836C85.5411 230.725 86.0783 230.547 87.3457 229.836C88.1311 229.395 88.8638 228.945 90.1318 228.195C91.3108 227.499 92.7167 226.688 94.416 225.801C101.666 222.016 105.776 218.896 111.535 215.119C118.102 210.813 123.459 209.13 126.396 208.052C131.036 206.349 136.425 205.744 152.252 205.31C159.648 205.107 163.937 207.601 166.489 208.669C173.103 211.436 176.055 211.941 178.941 212.562C181.978 213.215 184.014 213.679 186.554 214.016C191.566 214.679 194.37 215.103 197.164 215.038C204.441 214.869 206.639 213.826 207.619 213.312C210.195 211.96 211.166 210.586 214.062 207.328C215.486 205.725 220.323 199.497 224.57 193.894C227.897 189.506 231.094 185.327 235.414 181.602C240.409 177.293 247.216 174.368 251.312 173.416L251.663 173.339ZM269.871 234.674C270.015 234.665 270.158 234.657 270.303 234.648C270.141 234.479 269.978 234.307 269.814 234.135C269.832 234.312 269.852 234.492 269.871 234.674Z" fill="#036803"></path>
              <path d="M186.295 88.3333C185.225 88.3333 184.195 88.5 183.223 88.8083C182.077 85.4283 178.957 83 175.278 83C171.332 83 168.028 85.7967 167.113 89.5617C166.116 88.7722 164.883 88.3403 163.612 88.335C160.39 88.335 157.778 91.02 157.778 94.335C157.778 95.14 157.938 95.9033 158.218 96.6067C157.655 96.4334 157.071 96.3414 156.482 96.3333C152.902 96.3333 150 99.3183 150 103C150 106.682 152.902 109.667 156.482 109.667H186.297C192.023 109.667 196.667 104.893 196.667 99C196.667 93.1083 192.023 88.3333 186.295 88.3333Z" fill="#E1E8ED"></path>
              <path d="M163.295 35.3333C162.225 35.3333 161.195 35.5 160.223 35.8083C159.077 32.4283 155.957 30 152.278 30C148.332 30 145.028 32.7967 144.113 36.5617C143.116 35.7722 141.883 35.3403 140.612 35.335C137.39 35.335 134.778 38.02 134.778 41.335C134.778 42.14 134.938 42.9033 135.218 43.6067C134.655 43.4334 134.071 43.3414 133.482 43.3333C129.902 43.3333 127 46.3183 127 50C127 53.6817 129.902 56.6667 133.482 56.6667H163.297C169.023 56.6667 173.667 51.8933 173.667 46C173.667 40.1083 169.023 35.3333 163.295 35.3333Z" fill="#E1E8ED"></path>
              <path d="M255.295 55.3333C254.225 55.3333 253.195 55.5 252.223 55.8083C251.077 52.4283 247.957 50 244.278 50C240.332 50 237.028 52.7967 236.113 56.5617C235.116 55.7722 233.883 55.3403 232.612 55.335C229.39 55.335 226.778 58.02 226.778 61.335C226.778 62.14 226.938 62.9033 227.218 63.6067C226.655 63.4334 226.071 63.3414 225.482 63.3333C221.902 63.3333 219 66.3183 219 70C219 73.6817 221.902 76.6667 225.482 76.6667H255.297C261.023 76.6667 265.667 71.8933 265.667 66C265.667 60.1083 261.023 55.3333 255.295 55.3333Z" fill="#E1E8ED"></path>
              <path d="M318.295 74.3333C317.225 74.3333 316.195 74.5 315.223 74.8083C314.077 71.4283 310.957 69 307.278 69C303.332 69 300.028 71.7967 299.113 75.5617C298.116 74.7722 296.883 74.3403 295.612 74.335C292.39 74.335 289.778 77.02 289.778 80.335C289.778 81.14 289.938 81.9033 290.218 82.6067C289.655 82.4334 289.071 82.3414 288.482 82.3333C284.902 82.3333 282 85.3183 282 89C282 92.6817 284.902 95.6667 288.482 95.6667H318.297C324.023 95.6667 328.667 90.8933 328.667 85C328.667 79.1083 324.023 74.3333 318.295 74.3333Z" fill="#E1E8ED"></path>
              <path d="M341.295 38.3333C340.225 38.3333 339.195 38.5 338.223 38.8083C337.077 35.4283 333.957 33 330.278 33C326.332 33 323.028 35.7967 322.113 39.5617C321.116 38.7722 319.883 38.3403 318.612 38.335C315.39 38.335 312.778 41.02 312.778 44.335C312.778 45.14 312.938 45.9033 313.218 46.6067C312.655 46.4334 312.071 46.3414 311.482 46.3333C307.902 46.3333 305 49.3183 305 53C305 56.6817 307.902 59.6667 311.482 59.6667H341.297C347.023 59.6667 351.667 54.8933 351.667 49C351.667 43.1083 347.023 38.3333 341.295 38.3333Z" fill="#E1E8ED"></path>
              <path d="M42.8972 282.482C41.2956 282.482 39.9169 283.432 39.292 284.799C38.6463 284.343 37.8589 284.074 37.0081 284.074C34.8194 284.074 33.045 285.849 33.045 288.037C33.045 288.76 33.2392 289.436 33.5767 290.019C31.6762 290.311 30.2207 291.954 30.2207 293.936C30.2207 296.125 31.9951 297.899 34.1838 297.899C36.3725 297.899 46.8603 288.633 46.8603 286.445C46.8603 284.256 45.0861 282.482 42.8972 282.482Z" fill="#28A528"></path>
              <path d="M142 287.719C142 282.254 138.677 277.566 133.941 275.564C134.777 273.947 135.253 272.114 135.253 270.168C135.253 263.671 129.986 258.404 123.488 258.404C121.637 258.404 119.887 258.832 118.329 259.594C116.944 254.637 112.398 251 107 251C101.602 251 97.0559 254.637 95.6714 259.594C94.1134 258.832 92.3629 258.404 90.5117 258.404C84.0145 258.404 78.7475 263.671 78.7475 270.168C78.7475 272.114 79.2227 273.947 80.0591 275.564C75.3234 277.566 72 282.254 72 287.719C72 294.801 77.5836 300.572 84.588 300.888C85.5646 304.425 89.3357 307.062 93.8424 307.062C96.3967 307.062 98.7137 306.214 100.421 304.836C102.129 306.214 104.446 307.062 107 307.062C109.554 307.062 111.871 306.214 113.579 304.836C115.286 306.214 117.603 307.062 120.158 307.062C124.664 307.062 128.435 304.425 129.412 300.888C136.416 300.572 142 294.801 142 287.719Z" fill="#129B12"/>
              <path d="M106.294 251.023C106.149 251.032 106.005 251.042 105.862 251.056C105.818 251.061 105.774 251.066 105.73 251.07C105.576 251.087 105.423 251.106 105.271 251.129C105.242 251.133 105.214 251.137 105.185 251.142C105.004 251.17 104.824 251.201 104.646 251.238C104.646 251.238 104.646 251.238 104.646 251.238C107.734 251.866 110.625 254.017 112.457 256.728C113.754 258.648 115.97 259.755 118.282 259.597C118.298 259.596 118.313 259.595 118.328 259.594C116.944 254.637 112.398 251 107 251C106.811 251 106.623 251.005 106.436 251.014C106.388 251.017 106.342 251.021 106.294 251.023Z" fill="#097C09"/>
              <path d="M133.941 275.564C134.777 273.947 135.252 272.114 135.252 270.168C135.252 263.671 129.985 258.404 123.488 258.404C122.682 258.404 121.895 258.485 121.134 258.64C126.502 259.731 130.543 264.477 130.543 270.168C130.543 272.114 130.068 273.947 129.231 275.564C133.967 277.566 137.29 282.254 137.29 287.719C137.29 294.801 131.707 300.572 124.702 300.888C123.902 303.787 121.224 306.08 117.802 306.814C118.556 306.975 119.344 307.062 120.158 307.062C124.664 307.062 128.435 304.425 129.412 300.888C136.416 300.572 142 294.801 142 287.719C142 282.254 138.677 277.566 133.941 275.564Z" fill="#097C09"/>
              <path d="M98.5764 302.888C97.5154 304.687 93.1186 306.699 91.488 306.814C91.6674 306.852 91.8492 306.886 92.0326 306.916C92.0472 306.918 92.0619 306.921 92.0767 306.923C92.2625 306.952 92.4501 306.978 92.6397 306.998C92.6446 306.998 92.6495 306.999 92.6543 306.999C92.8249 307.017 92.9972 307.03 93.1705 307.041C93.2126 307.043 93.2549 307.046 93.2973 307.048C93.4779 307.056 93.6594 307.062 93.8426 307.062C96.1722 307.062 98.3027 306.355 99.9554 305.186L100.245 304.975L98.7695 302.554L98.5764 302.888Z" fill="#009000"/>
              <path d="M112.882 305.892L117.923 297.938C118.321 297.309 118.201 296.483 117.639 295.994C117.039 295.472 116.136 295.506 115.577 296.072L111.865 299.83C111.373 300.329 110.53 299.914 110.623 299.22L111.715 291.133C111.831 290.269 111.193 289.486 110.323 289.428L109.3 289.358C108.532 289.307 107.848 289.842 107.714 290.601L105.766 301.671C105.657 302.286 104.876 302.489 104.481 302.004L98.3792 294.5C97.957 293.981 97.2428 293.802 96.6259 294.061L95.5575 294.51C94.7116 294.866 94.377 295.888 94.849 296.675L101.12 307.127C102.028 308.641 102.402 310.417 102.175 312.167C101.362 318.435 100.353 324.346 96.2219 329.161H117.778C113.356 324.006 112.265 317.596 111.679 310.837C111.53 309.101 111.95 307.363 112.882 305.892Z" fill="#BF6101"/>
              <path d="M117.923 297.938C118.321 297.309 118.201 296.483 117.639 295.994C117.039 295.472 116.136 295.506 115.577 296.072L113.92 297.751L111.865 299.83C111.373 300.329 110.53 299.914 110.623 299.22L111.715 291.133C111.829 290.291 111.224 289.528 110.388 289.435L107.318 308.512C107.267 308.759 107.227 309.007 107.199 309.258C107.14 309.779 107.132 310.308 107.178 310.836C107.763 317.596 108.854 324.006 113.277 329.161H117.778C113.356 324.006 112.265 317.596 111.68 310.837C111.53 309.101 111.95 307.363 112.882 305.892L117.923 297.938Z" fill="#9A4D01"/>
              <path d="M104.761 260.236C101.46 260.236 98.6191 262.195 97.3311 265.012C96.0006 264.072 94.3778 263.518 92.6245 263.518C88.114 263.518 84.4573 267.175 84.4573 271.685C84.4573 273.173 84.8575 274.567 85.553 275.769C81.6364 276.371 78.637 279.756 78.637 283.841C78.637 288.351 82.2936 292.008 86.8042 292.008C91.3147 292.008 112.928 272.914 112.928 268.403C112.928 263.892 109.272 260.236 104.761 260.236Z" fill="#28A528"/>
              <path d="M395 277.473C395 272.789 392.151 268.771 388.092 267.055C388.809 265.669 389.216 264.097 389.216 262.43C389.216 256.861 384.702 252.346 379.133 252.346C377.546 252.346 376.046 252.713 374.71 253.366C373.524 249.118 369.627 246 365 246C360.373 246 356.476 249.118 355.29 253.366C353.954 252.713 352.454 252.346 350.867 252.346C345.298 252.346 340.784 256.861 340.784 262.43C340.784 264.097 341.191 265.669 341.908 267.055C337.849 268.771 335 272.789 335 277.473C335 283.544 339.786 288.491 345.79 288.761C346.627 291.793 349.859 294.053 353.722 294.053C355.911 294.053 357.897 293.326 359.361 292.145C360.825 293.326 362.811 294.053 365 294.053C367.189 294.053 369.175 293.326 370.639 292.145C372.103 293.326 374.089 294.053 376.278 294.053C380.141 294.053 383.373 291.793 384.21 288.761C390.214 288.49 395 283.544 395 277.473Z" fill="#129B12"/>
              <path d="M364.395 246.02C364.271 246.027 364.147 246.036 364.024 246.048C363.987 246.052 363.949 246.056 363.912 246.06C363.78 246.075 363.648 246.091 363.518 246.11C363.493 246.114 363.469 246.118 363.445 246.121C363.289 246.146 363.135 246.172 362.982 246.204C362.982 246.204 362.982 246.204 362.982 246.204C365.629 246.742 368.107 248.586 369.677 250.91C370.789 252.555 372.689 253.504 374.67 253.369C374.684 253.368 374.697 253.367 374.71 253.366C373.524 249.118 369.627 246 365 246C364.838 246 364.677 246.005 364.516 246.012C364.476 246.014 364.436 246.018 364.395 246.02Z" fill="#097C09"/>
              <path d="M388.092 267.055C388.809 265.669 389.216 264.097 389.216 262.43C389.216 256.861 384.702 252.346 379.133 252.346C378.441 252.346 377.767 252.416 377.115 252.549C381.716 253.484 385.18 257.552 385.18 262.43C385.18 264.097 384.772 265.669 384.055 267.055C388.115 268.771 390.963 272.789 390.963 277.474C390.963 283.544 386.177 288.49 380.174 288.761C379.488 291.246 377.192 293.212 374.259 293.84C374.905 293.979 375.581 294.053 376.278 294.053C380.141 294.053 383.373 291.793 384.21 288.761C390.214 288.49 395 283.544 395 277.473C395 272.789 392.152 268.771 388.092 267.055Z" fill="#097C09"/>
              <path d="M357.78 290.475C356.87 292.018 353.101 293.742 351.704 293.84C351.858 293.873 352.013 293.902 352.171 293.928C352.183 293.93 352.196 293.932 352.208 293.934C352.368 293.959 352.528 293.981 352.691 293.998C352.695 293.999 352.699 293.999 352.704 294C352.85 294.015 352.997 294.026 353.146 294.035C353.182 294.037 353.218 294.039 353.255 294.041C353.409 294.048 353.565 294.053 353.722 294.053C355.719 294.053 357.545 293.447 358.962 292.445L359.21 292.264L357.945 290.189L357.78 290.475Z" fill="#009000"/>
              <path d="M370.042 293.05L374.362 286.233C374.704 285.694 374.601 284.986 374.119 284.567C373.604 284.119 372.831 284.148 372.352 284.633L369.17 287.855C368.748 288.282 368.025 287.927 368.106 287.332L369.041 280.4C369.141 279.659 368.594 278.988 367.848 278.938L366.971 278.879C366.313 278.834 365.727 279.293 365.612 279.944L363.942 289.432C363.849 289.96 363.179 290.134 362.841 289.718L357.611 283.286C357.249 282.841 356.637 282.687 356.108 282.91L355.192 283.295C354.467 283.599 354.18 284.476 354.585 285.15L359.96 294.109C360.738 295.406 361.059 296.928 360.864 298.429C360.168 303.801 359.303 308.868 355.762 312.995H374.238C370.448 308.577 369.513 303.082 369.011 297.289C368.883 295.801 369.243 294.311 370.042 293.05Z" fill="#BF6101"/>
              <path d="M374.362 286.233C374.704 285.694 374.601 284.986 374.119 284.567C373.605 284.119 372.831 284.148 372.352 284.633L370.931 286.072L369.17 287.854C368.748 288.282 368.025 287.926 368.106 287.331L369.041 280.4C369.139 279.678 368.62 279.024 367.904 278.945L365.273 295.296C365.229 295.507 365.194 295.72 365.17 295.935C365.12 296.382 365.113 296.835 365.152 297.288C365.654 303.082 366.589 308.577 370.38 312.995H374.238C370.448 308.577 369.513 303.082 369.011 297.288C368.882 295.801 369.243 294.311 370.042 293.05L374.362 286.233Z" fill="#9A4D01"/>
              <path d="M363.081 253.916C360.252 253.916 357.817 255.595 356.713 258.011C355.572 257.205 354.181 256.73 352.678 256.73C348.812 256.73 345.678 259.864 345.678 263.73C345.678 265.006 346.021 266.201 346.617 267.231C343.26 267.747 340.689 270.648 340.689 274.149C340.689 278.015 343.823 281.15 347.689 281.15C351.556 281.15 370.081 264.783 370.081 260.917C370.081 257.051 366.947 253.916 363.081 253.916Z" fill="#28A528"/>
          </g>
          <defs>
              <linearGradient id="paint0_linear_9_73_game" x1="196.5" y1="0" x2="196.5" y2="262" gradientUnits="userSpaceOnUse">
                  <stop stopColor="#58E3F9"></stop>
                  <stop offset="0.884615" stopColor="#FFC958" stopOpacity="0.5"></stop>
              </linearGradient>
              <clipPath id="clip0_9_73_game">
                  <rect width="393" height="1722" fill="white"></rect>
              </clipPath>
          </defs>
      </svg>
    </div>
  );
};


// --- Main Game Page Component ---
export default function GamePage() {
    const router = useRouter();
    const { gainPetExp, addJourneyEntry, petTasks, setPetTasks } = useAuth();
    const [isInteracting, setIsInteracting] = useState(false);

    const handleTaskComplete = (taskId: number) => {
        const task = petTasks.find(t => t.id === taskId);
        if (task && !task.completed) {
            const newTasks = petTasks.map(t => t.id === taskId ? { ...t, completed: true } : t);
            setPetTasks(newTasks);
            gainPetExp(10);
            addJourneyEntry(`Completed goal: "${task.name}"`, task.icon);
            setIsInteracting(true);
            setTimeout(() => setIsInteracting(false), 500);
        }
    };
    
    const uncompletedTasksCount = useMemo(() => petTasks.filter(t => !t.completed).length, [petTasks]);

    return (
        <main className="min-h-dvh flex flex-col items-center p-0 font-body overflow-hidden relative bg-background">
            {/* Background */}
            <GameBackground />
            
            {/* Back Button */}
            <Button onClick={() => router.back()} variant="ghost" size="icon" className="absolute top-6 left-6 z-20 bg-background/50 backdrop-blur-sm rounded-full">
                <ArrowLeft />
            </Button>
            
            {/* Scene Content */}
            <div className="relative z-10 w-full h-[55vh] flex-shrink-0 flex flex-col items-center justify-end pb-8">
                <GamePet isInteracting={isInteracting} />
                <Button variant="secondary" className="mt-4 rounded-full px-6 shadow-lg" onClick={() => {
                    setIsInteracting(true);
                    setTimeout(() => setIsInteracting(false), 500);
                }}>
                    Chat with me!
                </Button>
            </div>

            {/* Goals Panel */}
            <div className="relative z-10 w-full flex-1 bg-background rounded-t-3xl pt-6 flex flex-col">
                <div className="px-6 pb-4">
                    <h2 className="text-lg font-semibold text-card-foreground">
                        {uncompletedTasksCount > 0 ? `${uncompletedTasksCount} goals left for today!` : "All goals complete!"}
                    </h2>
                </div>
                <div className="flex-1 overflow-y-auto px-4 custom-scrollbar pb-4">
                    <div className="space-y-3">
                        {petTasks.map((task) => (
                            <div key={task.id} className="flex items-center space-x-3 bg-white p-2 rounded-full shadow-md">
                                <span className="text-muted-foreground pl-2 cursor-grab"><GripVertical size={20} /></span>
                                <span className="text-xl">{task.icon}</span>
                                <Label htmlFor={`game-task-${task.id}`} className={cn("flex-grow text-base", task.completed && 'line-through text-muted-foreground')}>
                                    {task.name}
                                </Label>
                                <div className="flex items-center gap-2 pr-2">
                                    <span className="text-sm font-bold text-yellow-500 flex items-center gap-1">5 <Zap size={14}/></span>
                                     <div
                                        onClick={() => handleTaskComplete(task.id)}
                                        className={cn(
                                            "h-9 w-9 flex items-center justify-center rounded-full cursor-pointer transition-colors",
                                            task.completed ? "bg-green-500 text-white" : "bg-gray-200 text-gray-400 hover:bg-gray-300"
                                        )}
                                    >
                                        <CheckIcon size={20} />
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            </div>
        </main>
    );
}

    